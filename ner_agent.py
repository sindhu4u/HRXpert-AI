import os
import google.generativeai as genai
import re
def extract_resume_entities(extracted_text, hyperlinks):
    genai.configure(api_key=os.environ["GEMINI_API_KEY"])

    # Create the model
    generation_config = {
      "temperature": 1,
      "top_p": 0.95,
      "top_k": 64,
      "max_output_tokens": 8192,
      "response_mime_type": "text/plain",
    }

    model = genai.GenerativeModel(
      model_name="gemini-2.0-pro-exp-02-05",
      generation_config=generation_config,
      system_instruction="Do not generate any other content. You are a Resume Parser. Perform NER and extract:\nFull name, Professional Summary,  Job Title, Phone Number, Contact Information and Email Address,\nLinkedin, GitHub, Leetcode, and other profile hyperlinks (if provided), Education,\nWork Experience, Achievements, Hard and Soft Skills, Activities, Roles and Responsibilities,\nHobbies, Languages, the rest titled as Other.",
    )

    chat_session = model.start_chat(
      history=[
        {
          "role": "user",
          "parts": [
            "Sindhu R\nsindhur2004@gmail.com| LinkedIn | +91 82486 90613 | GitHub | LeetCode\nPROFESSIONAL SUMMARY\nAI & DS undergraduate with hands-on experience in AI projects and internships. Proficient in Python, ML, DL, and DSA. Skilled in developing innovative solutions and leading technical workshops.\nEDUCATION\nPSG Institute of Technology and Applied Research\tCoimbatore\nBTech. Artificial Intelligence and Data Science \t2022-2026\nCGPA (9.13 until IV Sem), an active AI & DS Association Member.\nThe PSBB Millennium School\tCoimbatore\nGrade 10 - 95.6% and Grade 12 - 96.4%\t2011-2022\nWORK EXPERIENCE\nSAP Labs\t Bengaluru\nAI Intern\tJun - Aug 2024\nDeveloped an SLM-powered Recommender System for Vendor Price Comparison, retrieving item prices from an SQL database that optimizes procurement decisions by suggesting vendors based on cost, delivery speed, and ratings, integrated into a web platform.\nRecognized in the Top 5 for outstanding contribution to the Summer Internship Project by SAP Labs.\nPROJECTS\nHate Speech Detection Using DL\nEngineered a web extension for real-time hate speech detection by developing an LSTM-based deep learning model, applying text preprocessing techniques to enhance accuracy and enabling users to identify online hate speech.\nID Card Generator\nDeveloped a Python-based ID card generator with an SQL database, integrating a Tkinter interface for seamless user input and automating ID card creation for PSG Group of Institutions, streamlining student record management.\nPsychological Analysis from Children's Drawings\nDeveloped a pipelined deep learning system using Qwen-2 VL for image analysis and Phi-3 for narrative generation to analyze children's drawings, extracting emotional insights and providing psychologists with data-driven interpretations.\nReinforcement Learning for Humanoid Walking\nTrained a humanoid agent in Mujoco using reinforcement learning to achieve stable and realistic walking motion by optimizing reward functions.\nLEADERSHIP ACTIVITIES\n●  AI & DS Association Executive Member, Head of Codeology – Organized coding workshops\n●  Class Representative – Coordinating class activities and communication\n●  Yukta 2024 Workshop Organizer – Conducted an RL Workshop\n●  Student Council Member & Debate Club Secretary in School\nSKILLS\nSkills: Python (Proficient) | C and C++ (Basics) | mySQL | Data Structures and Algorithms | Machine Learning | Deep Learning | Git and GitHub | Gen AI | Image and Video Analytics\nHobbies and Interests: Vocal Music | Art | Creative Writing | Debating\nLanguages: English, Tamil, Hindi, Kannada, Telugu.\nACHIEVEMENTS\nPlaced 1st in CodeBlitz - a coding competition organized by Kumaraguru Institutions\nRanked 2nd in school level for 12th Grade CBSE Board Exam\nRecognized for outstanding contribution to the Summer Internship Project by SAP Labs\n\nPerform NER as per given instructions and output the fields: related text as a dictionary ",
          ],
        },
        {
          "role": "model",
          "parts": [
            "```json\n{\n  \"Full name\": \"Sindhu R\",\n  \"Professional Summary\": \"AI & DS undergraduate with hands-on experience in AI projects and internships. Proficient in Python, ML, DL, and DSA. Skilled in developing innovative solutions and leading technical workshops.\",\n  \"Job Title\": \"AI Intern\",\n  \"Phone Number\": \"+91 82486 90613\",\n  \"Contact Information\": \"Coimbatore\",\n  \"Email Address\": \"sindhur2004@gmail.com\",\n  \"Linkedin\": \"LinkedIn\",\n  \"GitHub\": \"GitHub\",\n  \"Leetcode\": \"LeetCode\",\n  \"Education\": [\n    {\n      \"institution\": \"PSG Institute of Technology and Applied Research\",\n      \"location\": \"Coimbatore\",\n      \"degree\": \"BTech. Artificial Intelligence and Data Science\",\n      \"duration\": \"2022-2026\",\n      \"other\": \"CGPA (9.13 until IV Sem), an active AI & DS Association Member.\"\n    },\n    {\n      \"institution\": \"The PSBB Millennium School\",\n      \"location\": \"Coimbatore\",\n      \"degree\": null,\n      \"duration\": \"2011-2022\",\n      \"other\": \"Grade 10 - 95.6% and Grade 12 - 96.4%\"\n    }\n  ],\n  \"Work Experience\": [\n    {\n      \"company\": \"SAP Labs\",\n      \"location\": \"Bengaluru\",\n      \"title\": \"AI Intern\",\n      \"duration\": \"Jun - Aug 2024\",\n      \"responsibilities\": [\n        \"Developed an SLM-powered Recommender System for Vendor Price Comparison, retrieving item prices from an SQL database that optimizes procurement decisions by suggesting vendors based on cost, delivery speed, and ratings, integrated into a web platform.\"\n      ],\n      \"achievements\": [\n        \"Recognized in the Top 5 for outstanding contribution to the Summer Internship Project by SAP Labs.\"\n      ]\n    }\n  ],\n    \"Projects\":[\n      \"Hate Speech Detection Using DL\",\n       \"ID Card Generator\",\n        \"Psychological Analysis from Children's Drawings\",\n        \"Reinforcement Learning for Humanoid Walking\"\n  ],\n  \"Achievements\": [\n    \"Placed 1st in CodeBlitz - a coding competition organized by Kumaraguru Institutions\",\n    \"Ranked 2nd in school level for 12th Grade CBSE Board Exam\",\n    \"Recognized for outstanding contribution to the Summer Internship Project by SAP Labs\"\n  ],\n  \"Hard and Soft Skills\": [\n    \"Python (Proficient)\",\n    \"C and C++ (Basics)\",\n    \"mySQL\",\n    \"Data Structures and Algorithms\",\n    \"Machine Learning\",\n    \"Deep Learning\",\n    \"Git and GitHub\",\n    \"Gen AI\",\n    \"Image and Video Analytics\"\n  ],\n  \"Activities\": [\n    \"AI & DS Association Executive Member, Head of Codeology\",\n    \"Class Representative\",\n    \"Yukta 2024 Workshop Organizer\",\n    \"Student Council Member & Debate Club Secretary in School\"\n  ],\n   \"Roles and Responsibilities\":[\n       \"Organized coding workshops\",\n       \"Coordinating class activities and communication\",\n        \"Conducted an RL Workshop\"\n   ],\n  \"Hobbies\": [\n    \"Vocal Music\",\n    \"Art\",\n    \"Creative Writing\",\n    \"Debating\"\n  ],\n  \"Languages\": [\n    \"English\",\n    \"Tamil\",\n    \"Hindi\",\n    \"Kannada\",\n    \"Telugu\"\n  ],\n  \"Other\": []\n}\n```\n",
          ],
        },
        {
          "role": "user",
          "parts": [
            "Rosie Miller\n\nPittsburgh, PA 15201\n\n(555) 555-5555\n\nexample@example.com\n\nPROFESSIONAL SUMMARY\n\nExperienced Restaurant Manager bringing demonstrated success in developing and motivating strong restaurant teams capable of handling over 200 customers hourly. Keeps all areas clean and sanitized while managing inventory and preventing waste. Consistent career history of operations improvement, team building and revenue increases.\n\nWORK HISTORY\n\nMarch 2014 to Current\n\nOutback Steakhouse – Pittsburgh, PA\n\nRestaurant Manager\n\nReduced labor costs by 17% percent while maintaining excellent service and profit levels\nManaged a 7-person team of cooks and back of house staff and a team of 8 front house staff for a busy steakhouse restaurant\nContinuously evaluated business operations to effectively align workflows for optimal area coverage increasing customer satisfaction rating by 80%\nDecember 2010 to February 2014\n\nTGI Fridays – Pittsburgh, PA Assistant\n\nRestaurant Manager\n\nReduced restaurant’s annual food and labor costs by 15% through proper budgeting, scheduling and management of inventory\nKept restaurant compliant with all federal, state and local hygiene and food safety regulations which kept food safety score between 95-100 every inspection\nCoordinated kitchen stations with managers to cut down on customer wait times by 50%\nJuly 2007 to November 2010\n\nBJ’s Restaurants, Inc – Pittsburgh, PA\n\nRestaurant Team Leader\n\nAssisted customers in placing special orders for large-scale events such as corporate events and birthday parties\nRecruited and hired over 10 employees offering talent, charisma and experience to restaurant team\nPitched in to help host, waitstaff and bussers during exceptionally busy times such as dinner hour\nSKILLS\n\nConflict resolution techniques\n\nPerformance improvement\n\nStaff management\n\nService-oriented\n\nTrained in performance and wage reviews\n\nBusiness operations\n\nInventory control and record keeping\n\nMarketing and advertising\n\nEDUCATION\n\nPark Point University Pittsburgh, PA\n\nBachelor of Arts Hospitality Management\n\nPerform NER as per given instructions",
          ],
        },
        {
          "role": "model",
          "parts": [
            "```json\n{\n  \"Full name\": \"Rosie Miller\",\n  \"Professional Summary\": \"Experienced Restaurant Manager bringing demonstrated success in developing and motivating strong restaurant teams capable of handling over 200 customers hourly. Keeps all areas clean and sanitized while managing inventory and preventing waste. Consistent career history of operations improvement, team building and revenue increases.\",\n  \"Job Title\": \"Restaurant Manager\",\n  \"Phone Number\": \"(555) 555-5555\",\n  \"Contact Information\": \"Pittsburgh, PA 15201\",\n  \"Email Address\": \"example@example.com\",\n  \"Linkedin\": null,\n  \"GitHub\": null,\n  \"Leetcode\": null,\n  \"Education\": [\n    {\n      \"institution\": \"Park Point University\",\n      \"location\": \"Pittsburgh, PA\",\n      \"degree\": \"Bachelor of Arts Hospitality Management\",\n      \"duration\": null,\n      \"other\": null\n    }\n  ],\n  \"Work Experience\": [\n    {\n      \"company\": \"Outback Steakhouse\",\n      \"location\": \"Pittsburgh, PA\",\n      \"title\": \"Restaurant Manager\",\n      \"duration\": \"March 2014 to Current\",\n      \"responsibilities\": [\n        \"Managed a 7-person team of cooks and back of house staff and a team of 8 front house staff for a busy steakhouse restaurant\",\n        \"Continuously evaluated business operations to effectively align workflows for optimal area coverage increasing customer satisfaction rating by 80%\"\n      ],\n      \"achievements\": [\n        \"Reduced labor costs by 17% percent while maintaining excellent service and profit levels\"\n      ]\n    },\n    {\n      \"company\": \"TGI Fridays\",\n      \"location\": \"Pittsburgh, PA\",\n      \"title\": \"Assistant Restaurant Manager\",\n      \"duration\": \"December 2010 to February 2014\",\n      \"responsibilities\": [\n        \"Kept restaurant compliant with all federal, state and local hygiene and food safety regulations which kept food safety score between 95-100 every inspection\",\n        \"Coordinated kitchen stations with managers to cut down on customer wait times by 50%\"\n      ],\n      \"achievements\": [\n        \"Reduced restaurant’s annual food and labor costs by 15% through proper budgeting, scheduling and management of inventory\"\n      ]\n    },\n    {\n      \"company\": \"BJ’s Restaurants, Inc\",\n      \"location\": \"Pittsburgh, PA\",\n      \"title\": \"Restaurant Team Leader\",\n      \"duration\": \"July 2007 to November 2010\",\n      \"responsibilities\": [\n        \"Assisted customers in placing special orders for large-scale events such as corporate events and birthday parties\",\n        \"Recruited and hired over 10 employees offering talent, charisma and experience to restaurant team\",\n        \"Pitched in to help host, waitstaff and bussers during exceptionally busy times such as dinner hour\"\n      ],\n      \"achievements\": []\n    }\n  ],\n  \"Achievements\": [],\n  \"Hard and Soft Skills\": [\n    \"Conflict resolution techniques\",\n    \"Performance improvement\",\n    \"Staff management\",\n    \"Service-oriented\",\n    \"Trained in performance and wage reviews\",\n    \"Business operations\",\n    \"Inventory control and record keeping\",\n    \"Marketing and advertising\"\n  ],\n  \"Activities\": [],\n  \"Roles and Responsibilities\": [],\n  \"Hobbies\": [],\n  \"Languages\": [],\n  \"Other\": []\n}\n```\n",
          ],
        },
      ]
    )


    response = chat_session.send_message(extracted_text + str(hyperlinks)+ "\nPerform NER as per given instructions")
    json_string=response.text
    #print(response.text)
    email_pattern = r"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
    emails = re.findall(email_pattern, json_string)
    response = chat_session.send_message(response.text+"List out the Hard and Soft Skills alone now")
    
    return (emails[0],response.text)
